---
title: "ALM"
format:
  html:
    toc: true
    number-sections: true
    colorlinks: true
    self-contained: true
  pdf:
    toc: true
    number-sections: true
    colorlinks: true
    geometry:
      - left=0.5in
      - right=0.5in
      - top=0.5in
      - bottom=0.5in
    papersize: letter
    fontsize: 11pt
---

```{python}
# | label: setup
from datetime import date
import numpy as np
import polars as pl
import plotly.graph_objects as go
import plotly.io as pio
import os
from pathlib import Path
import sys

sys.path.insert(0, str((Path.cwd().parent) / "src"))
from alm.asset import Bond, Mortgage, PrivateCredit
from alm.liability import SPIA, Term, WL, FIA, qx_from_table
from alm.read import get_2012_iam_table, get_spread, read_treasury_rates, update_credit_spreads
from alm.core import (
    Block, InterestRateSwap, SAA,
    default_saa, spia_saa, term_saa,
    dv01, dollar_convexity, immunize,
)
from alm import plot
from great_tables import GT, loc, style

pdf_bool = os.environ.get("QUARTO_PROJECT_OUTPUT_FORMAT") == "pdf"
if pdf_bool:
    pio.renderers.default = "png"
else:
    pio.renderers.default = "notebook_connected+vscode"

update_credit_spreads()

today = date.today()
print(f"DATE: {today}")
print("AUTHOR: Brennen L. Slaney, FSA, Notary Public (GitHub: @realslimslaney)")
```


## Inputs

All model parameters live in this single code block.
Adjust values here to explore different portfolio compositions and market
conditions.

```{python}
# | label: inputs

# ── Global Parameters ─────────────────────────────────────────
DISCOUNT_RATE = 0.04  # flat annual discount rate
SEED = 42  # reproducibility
rng = np.random.default_rng(SEED)

# ── Mortality Table (SOA IAM 2012 Basic) ──────────────────────
mortality = get_2012_iam_table()  # combined male + female

# Simulated equity-index annual returns for FIA crediting
INDEX_RATES = rng.normal(0.05, 0.10, size=20).tolist()

# ── Strategic Asset Allocation ($10 B total face / principal) ─
assets = {
    "3yr Treasury": Bond(face_value=2_000_000_000, coupon_rate=0.030, maturity=3),
    "5yr Corporate": Bond(face_value=1_500_000_000, coupon_rate=0.035, maturity=5),
    "10yr Corporate": Bond(face_value=1_500_000_000, coupon_rate=0.040, maturity=10),
    "15yr MBS": Mortgage(principal=2_000_000_000, annual_rate=0.055, term=15),
    "30yr MBS": Mortgage(principal=3_000_000_000, annual_rate=0.060, term=30),
}

# ── Liability Portfolio ───────────────────────────────────────
liabilities = {
    "SPIA (Life Only)": SPIA(
        premium=2_000_000_000,
        annual_payout=150_000_000,
        qx=qx_from_table(mortality, 65, "male"),
        age=65,
    ),
    "SPIA (10yr Certain)": SPIA(
        premium=1_000_000_000,
        annual_payout=80_000_000,
        qx=qx_from_table(mortality, 70, "female"),
        age=70,
        certain_period=10,
    ),
    "20yr Term Life": Term(
        face_value=5_000_000_000,
        annual_premium=25_000_000,
        term=20,
        qx=qx_from_table(mortality, 40, "male"),
        age=40,
    ),
    "Whole Life": WL(
        face_value=2_000_000_000,
        annual_premium=30_000_000,
        qx=qx_from_table(mortality, 35, "female"),
        age=35,
    ),
    "FIA (10yr)": FIA(
        premium=50_000_000,
        term=10,
        qx=qx_from_table(mortality, 55, "male"),
        age=55,
        floor=0.01,
        cap=0.06,
    ),
}
```


## Market Environment

US Treasury constant-maturity rates from FRED — the benchmark yield
curve that drives asset pricing and liability discounting.

```{python}
#| label: fig-treasury-rates
ALL_TENORS = ["1M", "3M", "6M", "1Y", "2Y", "3Y", "5Y", "7Y", "10Y", "20Y", "30Y"]
treasury = read_treasury_rates(start="2020-01-01", tenors=ALL_TENORS).with_columns(
    [pl.col(t) / 100 for t in ALL_TENORS]      # FRED returns %; convert to decimal
)

plot.line_chart(
    treasury, x="date", y=["1Y", "10Y", "30Y"],
    title="US Treasury Rates (FRED)",
    xlab="", ylab="Rate",
    yformat="%",
).show()
```

### Current Yield Curve

The most recent available rates across all maturities, with spline
interpolation to visualise the full term structure.

```{python}
# | label: fig-yield-curve
TENOR_YEARS = {
    "1M": 1 / 12,
    "3M": 0.25,
    "6M": 0.5,
    "1Y": 1,
    "2Y": 2,
    "3Y": 3,
    "5Y": 5,
    "7Y": 7,
    "10Y": 10,
    "20Y": 20,
    "30Y": 30,
}

latest = treasury.drop_nulls().sort("date", descending=True).head(1)
curve_date = str(latest["date"][0])[:10]  # date only, no timestamp

maturities = [TENOR_YEARS[t] for t in ALL_TENORS]
rates = [latest[t][0] for t in ALL_TENORS]

TICK_TENORS = ["1M", "1Y", "2Y", "5Y", "10Y", "20Y", "30Y"]

fig = go.Figure()
fig.add_trace(
    go.Scatter(
        x=maturities,
        y=rates,
        mode="lines+markers",
        line=dict(color=plot.PALETTE[0], shape="spline", smoothing=1.3),
        marker=dict(color=plot.PALETTE[1], size=9),
        text=ALL_TENORS,
        hovertemplate="%{text}: %{y:.2%}<extra></extra>",
        showlegend=False,
    )
)
fig.update_layout(
    template="plotly_white",
    title=f"US Treasury Yield Curve ({curve_date})",
    xaxis_title="Maturity (Years)",
    yaxis_title="Rate",
    margin=dict(l=60, r=30, t=60, b=50),
)
fig.update_xaxes(
    tickvals=[TENOR_YEARS[t] for t in TICK_TENORS],
    ticktext=TICK_TENORS,
)
fig.update_yaxes(tickformat=".2%", hoverformat=".2%")
fig.show()
```


## Asset Cashflow Profiles

### Bond

A bullet bond pays level coupons with the full principal returned at
maturity — creating the characteristic "hockey-stick" pattern.

```{python}
#| label: fig-bond
inst = assets["10yr Corporate"]
bond_cf = inst.cashflows().with_columns(
    (pl.col("period") / inst.frequency).alias("year")
)

plot.bar_chart(
    bond_cf, x="year", y=["coupon", "principal"],
    title="10yr Corporate Bond — Cashflows",
    xlab="Year", ylab="Cashflow",
    yformat="$", barmode="stack",
).show()
```

### Mortgage (MBS)

A fully-amortizing mortgage has a level total payment, but the split
between interest and principal shifts over time.  Early payments are
dominated by interest; later payments are dominated by principal
repayment.

```{python}
#| label: fig-mortgage
inst = assets["30yr MBS"]
mtg_cf = inst.cashflows().with_columns(
    (pl.col("period") / inst.frequency).alias("year")
)

plot.line_chart(
    mtg_cf, x="year", y=["interest", "principal"],
    title="30yr Mortgage — Interest vs. Principal",
    xlab="Year", ylab="Monthly Payment",
    yformat="$",
).show()
```


## Liability Cashflow Profiles

### SPIA (Single Premium Immediate Annuity)

Expected payouts decline over time as the survival probability decreases.
The insurer's obligation shrinks as fewer annuitants remain alive.

```{python}
#| label: fig-spia
spia_cf = liabilities["SPIA (Life Only)"].cashflows()

plot.line_chart(
    spia_cf, x="year", y="expected_payout",
    title="SPIA (Life Only) — Expected Monthly Payouts",
    xlab="Year", ylab="Expected Payout",
    yformat="$",
).show()
```

### Term Life Insurance

Premium income declines as fewer policyholders survive to pay.
Expected death benefits reflect the underlying mortality curve.

```{python}
#| label: fig-term
term_cf = liabilities["20yr Term Life"].cashflows()

plot.line_chart(
    term_cf, x="year", y=["expected_premium", "expected_benefit"],
    title="20yr Term Life — Premiums vs. Expected Benefits",
    xlab="Year", ylab="Monthly Amount",
    yformat="$",
).show()
```

### Whole Life Insurance

Whole life covers the insured's entire lifetime.  Premiums are received
as long as the insured survives; the death benefit is paid whenever death
occurs.

```{python}
#| label: fig-wl
wl_cf = liabilities["Whole Life"].cashflows()

plot.line_chart(
    wl_cf, x="year", y=["expected_premium", "expected_benefit"],
    title="Whole Life — Premiums vs. Expected Benefits",
    xlab="Year", ylab="Monthly Amount",
    yformat="$",
).show()
```

### FIA (Fixed Indexed Annuity)

The FIA credits returns linked to an external index, subject to a floor
and cap.  Expected outflows include death benefits during the
accumulation period and a large maturity benefit at term end.

```{python}
#| label: fig-fia
fia_cf = liabilities["FIA (10yr)"].cashflows(INDEX_RATES)

plot.bar_chart(
    fia_cf, x="year", y=["expected_death_benefit", "expected_maturity_benefit"],
    title="FIA (10yr) — Expected Benefits",
    xlab="Year", ylab="Expected Benefit",
    yformat="$", barmode="stack",
).show()
```


## Combined Cashflow Views

### All Asset Cashflows

```{python}
# | label: fig-assets-combined
all_asset_rows = []
for name, inst in assets.items():
    cf = inst.cashflows()
    freq = inst.frequency
    cf = cf.with_columns((pl.col("period") / freq).alias("year"))

    if isinstance(inst, Bond):
        cf = cf.select("year", pl.col("total").alias("cashflow"))
    else:
        cf = cf.select("year", pl.col("payment").alias("cashflow"))

    cf = (
        cf.with_columns(pl.col("year").cast(pl.Float64).ceil().cast(pl.Int32))
        .group_by("year")
        .agg(pl.col("cashflow").sum())
        .sort("year")
        .with_columns(pl.lit(name).alias("instrument"))
    )
    all_asset_rows.append(cf)

asset_cf_all = pl.concat(all_asset_rows)

plot.bar_chart(
    asset_cf_all,
    x="year",
    y="cashflow",
    color="instrument",
    title="Asset Cashflows by Instrument (Annual)",
    xlab="Year",
    ylab="Annual Cashflow",
    yformat="$",
    barmode="stack",
).show()
```

### All Liability Cashflows

```{python}
#| label: fig-liabilities-combined
all_liab_rows = []
for name, inst in liabilities.items():
    if isinstance(inst, FIA):
        cf = inst.cashflows(INDEX_RATES)
    else:
        cf = inst.cashflows()

    if isinstance(inst, SPIA):
        cf = cf.select("year", pl.col("expected_payout").alias("cashflow"))
    else:
        cf = cf.select("year", pl.col("net_cashflow").alias("cashflow"))

    cf = (
        cf.with_columns(pl.col("year").cast(pl.Float64).ceil().cast(pl.Int32))
        .group_by("year").agg(pl.col("cashflow").sum())
        .sort("year")
        .with_columns(pl.lit(name).alias("instrument"))
    )
    all_liab_rows.append(cf)

liab_cf_all = pl.concat(all_liab_rows)

plot.bar_chart(
    liab_cf_all, x="year", y="cashflow", color="instrument",
    title="Liability Cashflows by Instrument (Annual)",
    xlab="Year", ylab="Annual Net Cashflow",
    yformat="$", barmode="stack",
).show()
```


## Block-Level Analysis

A **Block** groups a single liability type with a matching asset portfolio
built from a **Strategic Asset Allocation (SAA)**.  The `Block` class
generates N individual policies with randomised ages and genders, then
constructs assets to back them.

### Strategic Asset Allocations

Each liability type uses a tailored SAA — longer-duration blocks
tilt toward government bonds, while shorter-duration blocks increase
their mortgage allocation.

```{python}
#| label: tbl-saa
saa_data = pl.DataFrame({
    "Asset Class": ["Government Bonds", "Corporate Bonds", "Mortgages", "Private Credit"],
    "Default": [0.40, 0.30, 0.20, 0.10],
    "SPIA": [0.50, 0.30, 0.10, 0.10],
    "Term": [0.30, 0.30, 0.30, 0.10],
})

(
    GT(saa_data, rowname_col="Asset Class")
    .tab_header(
        title="Strategic Asset Allocations",
        subtitle="Target weights by liability block type",
    )
    .fmt_percent(columns=["Default", "SPIA", "Term"], decimals=0)
    .tab_source_note("Weights must sum to 100 %. Private credit capped at 10 %.")
)
```

### SPIA Block

500 single-premium immediate annuities, ages 65–80, backed by a
long-duration SAA (50 % government bonds, 30 % corporate, 10 % mortgages,
10 % private credit).

```{python}
#| label: fig-spia-block
spia_block = Block(
    liability_type="SPIA",
    saa=spia_saa(),
    total_liability_amount=5_000_000_000,
    mortality_table=mortality,
    age_range=(65, 80),
    discount_rate=DISCOUNT_RATE,
    n_policies=500,
    seed=SEED,
)
spia_block.generate_policies()
spia_block.generate_assets()
spia_block.plot_cashflows().show()
```

### Term Block

500 twenty-year term life policies, ages 35–55, backed by a shorter-
duration SAA (40 % government bonds, 30 % corporate, 20 % mortgages,
10 % private credit).

```{python}
#| label: fig-term-block
term_block = Block(
    liability_type="Term",
    saa=default_saa(),
    total_liability_amount=10_000_000_000,
    mortality_table=mortality,
    age_range=(35, 55),
    discount_rate=DISCOUNT_RATE,
    n_policies=500,
    seed=SEED,
)
term_block.generate_policies()
term_block.generate_assets()
term_block.plot_cashflows().show()
```

## Yield Decomposition

Fixed-income instruments earn different yields depending on the
credit, liquidity, and structural risks embedded in the asset.  This
section compares a representative **Treasury**, **Corporate**, and
**Private Credit** bond side-by-side so the reader can see how each
layer of spread adds to the total yield.

```{python}
#| label: yield-decomp-setup
# Representative 5-year instruments
corp_spread = get_spread("A", 5)

treasury_5yr = Bond(
    face_value=100_000_000, coupon_rate=DISCOUNT_RATE, maturity=5,
)
corporate_5yr = Bond(
    face_value=100_000_000, coupon_rate=DISCOUNT_RATE + corp_spread, maturity=5,
    rating="A", credit_spread=corp_spread,
)
pc_5yr = PrivateCredit(
    face_value=100_000_000, maturity=5,
    risk_free_rate=DISCOUNT_RATE, credit_spread=0.015,
    illiquidity_spread=0.020, other_spread=0.005,
)
```

### Yield Composition

```{python}
#| label: tbl-yield-decomp
yield_data = pl.DataFrame({
    "Component": [
        "Risk-Free Rate", "Credit Spread",
        "Illiquidity Spread", "Other Spread", "Total Yield",
    ],
    "5yr Treasury": [DISCOUNT_RATE, 0.0, 0.0, 0.0, DISCOUNT_RATE],
    "5yr Corporate (A)": [
        DISCOUNT_RATE, corp_spread, 0.0, 0.0, DISCOUNT_RATE + corp_spread,
    ],
    "5yr Private Credit": [
        pc_5yr.risk_free_rate, pc_5yr.credit_spread,
        pc_5yr.illiquidity_spread, pc_5yr.other_spread, pc_5yr.total_yield,
    ],
})

cols = ["5yr Treasury", "5yr Corporate (A)", "5yr Private Credit"]

(
    GT(yield_data, rowname_col="Component")
    .tab_header(
        title="Yield Decomposition",
        subtitle="5-year instruments compared side by side",
    )
    .fmt_percent(columns=cols, decimals=2)
    .tab_style(
        style=style.text(weight="bold"),
        locations=loc.body(rows=[4]),
    )
    .tab_source_note(
        "Treasury = risk-free only. Corporate adds credit spread. "
        "Private credit adds illiquidity and complexity premia."
    )
)
```

### Risk Metrics

```{python}
#| label: tbl-risk-metrics
metrics_data = pl.DataFrame({
    "Metric": ["Present Value", "Duration (yrs)", "Convexity", "DV01"],
    "5yr Treasury": [
        treasury_5yr.present_value(DISCOUNT_RATE),
        treasury_5yr.duration(DISCOUNT_RATE),
        treasury_5yr.convexity(DISCOUNT_RATE),
        dv01(treasury_5yr.present_value, DISCOUNT_RATE),
    ],
    "5yr Corporate (A)": [
        corporate_5yr.present_value(DISCOUNT_RATE),
        corporate_5yr.duration(DISCOUNT_RATE),
        corporate_5yr.convexity(DISCOUNT_RATE),
        dv01(corporate_5yr.present_value, DISCOUNT_RATE),
    ],
    "5yr Private Credit": [
        pc_5yr.present_value(DISCOUNT_RATE),
        pc_5yr.duration(DISCOUNT_RATE),
        pc_5yr.convexity(DISCOUNT_RATE),
        dv01(lambda r: pc_5yr.present_value(r), DISCOUNT_RATE),
    ],
})

(
    GT(metrics_data, rowname_col="Metric")
    .tab_header(title="Risk Metrics — 5-Year Instruments")
    .fmt_currency(columns=cols, rows=[0, 3], decimals=0)
    .fmt_number(columns=cols, rows=[1, 2], decimals=2)
    .tab_source_note(
        "PV discounted at the flat rate. "
        "PC present value uses risk-free rate, capturing the illiquidity premium."
    )
)
```

### Historical Yield Comparison

Adding the assumed spreads to the Treasury 5Y rate shows how
each instrument's yield moves over time.

```{python}
#| label: fig-yield-comparison
pc_total_spread = (
    pc_5yr.credit_spread + pc_5yr.illiquidity_spread + pc_5yr.other_spread
)

yields = treasury.select(
    "date",
    pl.col("5Y").alias("Treasury"),
    (pl.col("5Y") + corp_spread).alias("Corporate (A)"),
    (pl.col("5Y") + pc_total_spread).alias("Private Credit"),
).drop_nulls()

plot.line_chart(
    yields, x="date", y=["Treasury", "Corporate (A)", "Private Credit"],
    title="Historical Yield Comparison — 5-Year Instruments",
    xlab="", ylab="Yield",
    yformat="%",
).show()
```
